// This is your Prisma schema file
// Learn more: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// AUTHENTICATION & USER MANAGEMENT
// ============================================================================

model User {
  id                      String    @id @default(uuid())
  name                    String
  email                   String    @unique
  emailVerified           Boolean   @default(false)
  passwordHash            String
  image                   String?
  firmName                String?
  role                    String    @default("user") // user, admin, superadmin
  subscriptionTier        String    @default("free") // free, pro, professional, enterprise
  subscriptionStatus      String    @default("active") // active, cancelled, past_due
  stripeCustomerId        String?   @unique
  twoFactorEnabled        Boolean   @default(false)
  twoFactorSecret         String?
  status                  String    @default("pending_verification") // pending_verification, active, suspended, deleted
  marketingOptIn          Boolean   @default(false)
  failedLoginAttempts     Int       @default(0)
  lockedUntil             DateTime?
  onboardingCompleted     Boolean   @default(false)
  onboardingRole          String? // Solo, Associate, Partner, In-House Counsel, etc.
  onboardingPracticeAreas Json? // Array of practice areas selected
  // Beta program fields
  isBetaUser              Boolean   @default(false)
  betaTrialEndsAt         DateTime?
  earlyAdopter            Boolean   @default(false)
  betaInvitedAt           DateTime?
  createdAt               DateTime  @default(now())
  updatedAt               DateTime  @updatedAt
  lastLoginAt             DateTime?

  // Relations
  sessions              Session[]
  toolRuns              ToolRun[]
  projects              Project[]
  tickets               SupportTicket[]
  auditLogs             AuditLog[]
  organizationMembers   OrganizationMember[]
  workspaceMembers      WorkspaceMember[]
  favorites             Favorite[]
  templates             Template[]
  chatbotConversations  ChatbotConversation[]
  invitationsSent       OrganizationInvitation[]     @relation("InvitationInviter")
  invitationsAccepted   OrganizationInvitation[]     @relation("InvitationAccepter")
  comments              Comment[]
  notifications         Notification[]
  activityLogs          ActivityLog[]                @relation("UserActivityLog")
  shares                Share[]
  createdDocuments      ProjectDocument[]            @relation("CreatedDocuments")
  createdDocVersions    ProjectDocumentVersion[]     @relation("CreatedDocumentVersions")
}

model Session {
  id           String   @id @default(uuid())
  userId       String
  sessionToken String   @unique
  ipAddress    String?
  userAgent    String?
  expiresAt    DateTime
  createdAt    DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model EmailVerification {
  id        String   @id @default(uuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())

  @@index([token])
}

model PasswordReset {
  id        String   @id @default(uuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())

  @@index([token])
}

// ============================================================================
// MULTI-TENANT ORGANIZATION MANAGEMENT
// ============================================================================

model Organization {
  id                   String   @id @default(uuid())
  name                 String
  description          String?
  type                 String? // law_firm, corporate, solo, consultant
  planTier             String   @default("free") // free, pro, professional, enterprise
  subscriptionStatus   String   @default("active") // active, trialing, past_due, cancelled
  seatsTotal           Int      @default(1)
  seatsUsed            Int      @default(0)
  stripeSubscriptionId String?  @unique
  billingEmail         String?
  status               String   @default("active") // active, suspended, deleted
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  // Relations
  members     OrganizationMember[]
  invitations OrganizationInvitation[]
  workspaces  Workspace[]
  projects    Project[]
  
  // Phase 12: Financial Core Relations
  contacts          Contact[]
  matters           Matter[]
  timeEntries       TimeEntry[]
  chartOfAccounts   ChartOfAccount[]
  journalEntries    JournalEntry[]
  generalLedgerEntries GeneralLedgerEntry[]
  trustAccounts     TrustAccount[]
  invoices          Invoice[]
  payments          Payment[]
  billingRates      BillingRate[]
  expenses          Expense[]
  vendors           Vendor[]
  vendorBills       VendorBill[]
  vendorPayments    VendorPayment[]
  expensePolicies   ExpensePolicy[]
  financialAnomalies FinancialAnomaly[]

  @@index([status])
}

model OrganizationMember {
  id             String    @id @default(uuid())
  organizationId String
  userId         String
  role           String    @default("member") // owner, admin, member, viewer
  invitedBy      String?
  invitedAt      DateTime?
  joinedAt       DateTime?
  status         String    @default("active") // pending, active, suspended
  createdAt      DateTime  @default(now())

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([organizationId, userId])
  @@index([organizationId])
  @@index([userId])
}

model OrganizationInvitation {
  id             String    @id @default(uuid())
  organizationId String
  email          String
  role           String    @default("member") // owner, admin, member, viewer
  token          String    @unique
  status         String    @default("pending") // pending, accepted, declined, expired
  invitedBy      String
  acceptedBy     String?
  createdAt      DateTime  @default(now())
  acceptedAt     DateTime?
  expiresAt      DateTime

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  inviter      User         @relation("InvitationInviter", fields: [invitedBy], references: [id])
  accepter     User?        @relation("InvitationAccepter", fields: [acceptedBy], references: [id])

  @@index([organizationId])
  @@index([email])
  @@index([token])
  @@index([status])
}

model Workspace {
  id             String   @id @default(uuid())
  organizationId String?
  name           String
  description    String?
  type           String   @default("personal") // personal, team
  ownerId        String
  isDefault      Boolean  @default(false)
  status         String   @default("active") // active, archived
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization Organization?     @relation(fields: [organizationId], references: [id])
  members      WorkspaceMember[]
  projects     Project[]
  activityLogs ActivityLog[]

  @@index([organizationId])
  @@index([ownerId])
}

model WorkspaceMember {
  id          String   @id @default(uuid())
  workspaceId String
  userId      String
  role        String   @default("member") // admin, member, viewer
  permissions Json? // Granular permissions for future use
  createdAt   DateTime @default(now())

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([workspaceId, userId])
  @@index([workspaceId])
  @@index([userId])
}

// ============================================================================
// TOOL CATALOG & EXECUTION
// ============================================================================

model Category {
  id          String   @id @default(uuid())
  name        String
  slug        String   @unique
  description String?
  icon        String?
  sortOrder   Int      @default(0)
  createdAt   DateTime @default(now())

  tools Tool[]

  @@index([slug])
}

model Tool {
  id             String   @id @default(uuid())
  name           String
  slug           String   @unique
  description    String   @db.Text
  categoryId     String
  inputType      String // text, document, structured
  outputType     String // text, document, json
  pricingTier    String // free, pro, professional, enterprise
  aiModel        String   @default("claude-sonnet-4.5")
  popular        Boolean  @default(false)
  featured       Boolean  @default(false)
  status         String   @default("active") // active, beta, deprecated
  promptTemplate String   @db.Text
  systemPrompt   String?  @db.Text
  maxTokens      Int      @default(4000)
  temperature    Float    @default(0.7)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  category Category  @relation(fields: [categoryId], references: [id])
  runs     ToolRun[]

  @@index([categoryId])
  @@index([slug])
  @@index([pricingTier])
  @@index([popular])
}

model ToolRun {
  id              String    @id @default(uuid())
  userId          String
  toolId          String
  projectId       String?
  inputText       String    @db.Text
  outputText      String?   @db.Text
  status          String    @default("pending") // pending, processing, completed, failed
  aiModelUsed     String
  tokensUsed      Int?
  cost            Float?
  runTimeMs       Int?
  errorMsg        String?   @db.Text
  evaluationScore Float?
  evaluationData  Json?
  evaluatedAt     DateTime?
  createdAt       DateTime  @default(now())
  completedAt     DateTime?

  user    User     @relation(fields: [userId], references: [id])
  tool    Tool     @relation(fields: [toolId], references: [id])
  project Project? @relation(fields: [projectId], references: [id])

  @@index([userId])
  @@index([toolId])
  @@index([projectId])
  @@index([status])
  @@index([createdAt])
}

model Favorite {
  id        String   @id @default(uuid())
  userId    String
  toolId    String
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, toolId])
  @@index([userId])
}

model Template {
  id          String   @id @default(uuid())
  userId      String
  toolId      String
  name        String
  description String?  @db.Text
  content     Json // Stores the form data/input
  isPublic    Boolean  @default(false)
  category    String? // e.g., "Contracts", "Litigation", "Corporate"
  useCount    Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([toolId])
  @@index([category])
}

// ============================================================================
// PROJECT MANAGEMENT
// ============================================================================

model Project {
  id             String   @id @default(uuid())
  organizationId String?
  workspaceId    String?
  name           String
  description    String?  @db.Text
  status         String   @default("active") // active, completed, archived
  privacy        String   @default("private") // private, team, public
  createdBy      String
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization Organization?     @relation(fields: [organizationId], references: [id])
  workspace    Workspace?        @relation(fields: [workspaceId], references: [id])
  creator      User              @relation(fields: [createdBy], references: [id])
  runs         ToolRun[]
  documents    ProjectDocument[]

  @@index([organizationId])
  @@index([workspaceId])
  @@index([createdBy])
  @@index([status])
}

model ProjectDocument {
  id               String   @id @default(uuid())
  projectId        String
  workspaceId      String?
  organizationId   String?
  name             String
  description      String?  @db.Text
  originalFileName String
  storageKey       String // S3/Blob storage key
  mimeType         String
  sizeBytes        Int
  status           String   @default("uploaded") // uploaded, processed, failed
  createdById      String
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  project  Project                  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  creator  User                     @relation("CreatedDocuments", fields: [createdById], references: [id])
  versions ProjectDocumentVersion[]

  @@index([projectId])
  @@index([workspaceId])
  @@index([organizationId])
  @@index([createdById])
  @@index([status])
}

model ProjectDocumentVersion {
  id            String   @id @default(uuid())
  documentId    String
  versionNumber Int
  storageKey    String // S3/Blob storage key for this version
  mimeType      String
  sizeBytes     Int
  changelog     String?  @db.Text
  createdById   String
  createdAt     DateTime @default(now())

  document ProjectDocument @relation(fields: [documentId], references: [id], onDelete: Cascade)
  creator  User            @relation("CreatedDocumentVersions", fields: [createdById], references: [id])

  @@unique([documentId, versionNumber])
  @@index([documentId])
  @@index([createdById])
}

// ============================================================================
// SUPPORT SYSTEM
// ============================================================================

model SupportTicket {
  id           String    @id @default(uuid())
  ticketNumber String    @unique
  userId       String
  subject      String
  category     String // account, billing, technical, tool_feedback, feature_request
  priority     String    @default("medium") // low, medium, high, urgent
  status       String    @default("open") // open, in_progress, waiting_on_customer, resolved, closed
  assignedTo   String?
  attachments  Json? // Array of {name, url, size, type}
  mergedIntoId String? // For ticket merging
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  resolvedAt   DateTime?

  user          User            @relation(fields: [userId], references: [id])
  messages      TicketMessage[]
  mergedInto    SupportTicket?  @relation("TicketMerge", fields: [mergedIntoId], references: [id], onDelete: SetNull)
  mergedTickets SupportTicket[] @relation("TicketMerge")

  @@index([userId])
  @@index([status])
  @@index([ticketNumber])
  @@index([mergedIntoId])
}

model TicketMessage {
  id         String   @id @default(uuid())
  ticketId   String
  senderId   String
  senderType String // user, admin, system
  message    String   @db.Text
  createdAt  DateTime @default(now())

  ticket SupportTicket @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  @@index([ticketId])
}

// ============================================================================
// AUDIT LOGS & ANALYTICS
// ============================================================================

model AuditLog {
  id        String   @id @default(uuid())
  userId    String?
  eventType String // login, logout, tool_run, subscription_change, etc.
  eventData Json?
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())

  user User? @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([eventType])
  @@index([createdAt])
}

// ============================================================================
// BILLING & SUBSCRIPTIONS
// ============================================================================

model Transaction {
  id                  String   @id @default(uuid())
  userId              String
  organizationId      String?
  amount              Float
  currency            String   @default("USD")
  status              String // pending, completed, failed, refunded
  type                String // subscription, one_time
  stripePaymentId     String?  @unique
  paypalTransactionId String?  @unique
  metadata            Json?
  createdAt           DateTime @default(now())

  @@index([userId])
  @@index([organizationId])
  @@index([status])
}

model Refund {
  id            String    @id @default(uuid())
  transactionId String
  userId        String
  amount        Float
  reason        String?   @db.Text
  status        String    @default("pending") // pending, approved, rejected, processed
  requestedAt   DateTime  @default(now())
  processedAt   DateTime?

  @@index([userId])
  @@index([transactionId])
  @@index([status])
}

// ============================================================================
// HELP CENTER & KNOWLEDGE BASE
// ============================================================================

model HelpCategory {
  id          String   @id @default(uuid())
  name        String
  slug        String   @unique
  description String?
  icon        String?
  order       Int      @default(0)
  published   Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  articles HelpArticle[]

  @@index([slug])
  @@index([published])
}

model HelpArticle {
  id              String   @id @default(uuid())
  categoryId      String
  title           String
  slug            String   @unique
  content         String   @db.Text
  excerpt         String?
  author          String   @default("Frith AI Team")
  tags            Json?
  published       Boolean  @default(true)
  featured        Boolean  @default(false)
  views           Int      @default(0)
  helpfulVotes    Int      @default(0)
  notHelpfulVotes Int      @default(0)
  videoUrl        String?
  relatedArticles Json?
  seoTitle        String?
  seoDescription  String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  category HelpCategory @relation(fields: [categoryId], references: [id])

  @@index([categoryId])
  @@index([slug])
  @@index([published])
  @@index([featured])
}

model VideoTutorial {
  id          String   @id @default(uuid())
  title       String
  slug        String   @unique
  description String?  @db.Text
  videoUrl    String
  thumbnail   String?
  duration    Int?
  category    String
  tags        Json?
  views       Int      @default(0)
  published   Boolean  @default(true)
  order       Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([slug])
  @@index([published])
  @@index([category])
}

model Feedback {
  id         String   @id @default(uuid())
  userId     String?
  type       String // general, feature_request, bug_report
  category   String?
  subject    String
  message    String   @db.Text
  rating     Int?
  page       String?
  userAgent  String?
  status     String   @default("new") // new, reviewing, planned, implemented, declined
  adminNotes String?  @db.Text
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([userId])
  @@index([type])
  @@index([status])
}

// ============================================================================
// SYSTEM STATUS & INCIDENTS
// ============================================================================

model SystemIncident {
  id               String    @id @default(uuid())
  title            String
  description      String    @db.Text
  status           String // investigating, identified, monitoring, resolved
  severity         String // minor, major, critical
  affectedServices Json?
  startedAt        DateTime
  resolvedAt       DateTime?
  updates          Json? // Array of incident updates
  createdBy        String?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  @@index([status])
  @@index([severity])
  @@index([startedAt])
}

model MaintenanceWindow {
  id               String   @id @default(uuid())
  title            String
  description      String   @db.Text
  scheduledStart   DateTime
  scheduledEnd     DateTime
  affectedServices Json?
  status           String   @default("scheduled") // scheduled, in_progress, completed, cancelled
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@index([scheduledStart])
  @@index([status])
}

// ============================================================================
// HELP CENTER SEARCH ANALYTICS
// ============================================================================

model HelpSearchQuery {
  id           String   @id @default(uuid())
  query        String
  resultsCount Int
  userId       String?
  createdAt    DateTime @default(now())

  @@index([query])
  @@index([userId])
  @@index([createdAt])
}

// ============================================================================
// AI CHATBOT SYSTEM
// ============================================================================

model ChatbotConversation {
  id              String    @id @default(uuid())
  userId          String? // null if anonymous
  sessionId       String    @unique
  pageUrl         String?
  userAgent       String?
  startedAt       DateTime  @default(now())
  endedAt         DateTime?
  leadCaptured    Boolean   @default(false)
  emailCaptured   String?
  converted       Boolean   @default(false) // signup or upgrade
  escalated       Boolean   @default(false)
  sentiment       String? // positive, neutral, negative
  feedback        String? // helpful, not_helpful
  feedbackComment String?

  user     User?            @relation(fields: [userId], references: [id])
  messages ChatbotMessage[]
  leads    ChatbotLead[]

  @@index([userId])
  @@index([sessionId])
  @@index([startedAt])
  @@index([leadCaptured])
  @@index([converted])
}

model ChatbotMessage {
  id             String   @id @default(uuid())
  conversationId String
  senderType     String // user, bot, admin
  senderId       String? // user_id or admin_user_id
  message        String
  intent         String? // classified intent (pricing, support, demo, etc.)
  attachments    Json?
  createdAt      DateTime @default(now())

  conversation ChatbotConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@index([senderType])
  @@index([createdAt])
}

model ChatbotLead {
  id             String   @id @default(uuid())
  conversationId String
  email          String
  name           String?
  company        String?
  role           String?
  firmSize       String?
  practiceAreas  Json?
  leadScore      String? // high, medium, low
  sourcePage     String?
  createdAt      DateTime @default(now())

  conversation ChatbotConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@index([email])
  @@index([leadScore])
  @@index([createdAt])
}

// ============================================================================
// COLLABORATION FEATURES
// ============================================================================

model Comment {
  id         String   @id @default(uuid())
  content    String
  authorId   String
  targetType String // tool_run, project, document
  targetId   String
  parentId   String? // for threaded comments
  mentions   Json? // array of user IDs mentioned
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  author   User      @relation(fields: [authorId], references: [id], onDelete: Cascade)
  parent   Comment?  @relation("CommentThread", fields: [parentId], references: [id])
  replies  Comment[] @relation("CommentThread")

  @@index([targetType, targetId])
  @@index([authorId])
  @@index([createdAt])
}

model Notification {
  id         String   @id @default(uuid())
  userId     String
  type       String // mention, comment, share, invite
  title      String
  message    String
  data       Json? // additional context data
  read       Boolean  @default(false)
  actionUrl  String?
  createdAt  DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([read])
  @@index([createdAt])
}

model ActivityLog {
  id          String   @id @default(uuid())
  userId      String
  workspaceId String?
  action      String // created, updated, shared, commented
  targetType  String // tool_run, project, workspace, comment
  targetId    String
  description String
  metadata    Json?
  createdAt   DateTime @default(now())

  user      User       @relation("UserActivityLog", fields: [userId], references: [id], onDelete: Cascade)
  workspace Workspace? @relation(fields: [workspaceId], references: [id])

  @@index([userId])
  @@index([workspaceId])
  @@index([createdAt])
  @@index([targetType, targetId])
}

model Share {
  id          String    @id @default(uuid())
  ownerId     String
  targetType  String // tool_run, project, document
  targetId    String
  shareType   String // public, workspace, specific_users
  shareWith   Json? // array of user IDs for specific_users type
  permissions Json? // read, write, comment
  expiresAt   DateTime?
  createdAt   DateTime  @default(now())

  owner User @relation(fields: [ownerId], references: [id], onDelete: Cascade)

  @@index([ownerId])
  @@index([targetType, targetId])
  @@index([shareType])
}

// ============================================================================
// INTEGRATIONS
// ============================================================================

model ClioConnection {
  id           String   @id @default(uuid())
  userId       String
  accessToken  String
  refreshToken String
  expiresAt    DateTime
  scopes       Json? // Array of OAuth scopes
  clioUserId   String?
  clioFirmId   String?
  status       String   @default("active") // active, revoked, expired
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([userId])
  @@index([status])
}

model HubSpotConnection {
  id           String   @id @default(uuid())
  userId       String
  accessToken  String
  refreshToken String
  expiresAt    DateTime
  portalId     String?
  status       String   @default("active") // active, revoked, expired
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([userId])
  @@index([status])
}

model ZapierEvent {
  id        String   @id @default(uuid())
  userId    String
  eventType String // tool_run_created, tool_run_completed, project_created
  payload   Json
  consumed  Boolean  @default(false)
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([eventType])
  @@index([consumed])
  @@index([createdAt])
}

// ============================================================================
// WORKFLOWS & AUTOMATION
// ============================================================================

model Workflow {
  id             String   @id @default(uuid())
  workspaceId    String?
  organizationId String?
  name           String
  description    String?  @db.Text
  status         String   @default("draft") // draft, active, archived
  createdById    String
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  steps WorkflowStep[]
  runs  WorkflowRun[]

  @@index([workspaceId])
  @@index([organizationId])
  @@index([createdById])
  @@index([status])
}

model WorkflowStep {
  id               String  @id @default(uuid())
  workflowId       String
  order            Int
  toolId           String
  name             String?
  config           Json // Input configuration and mappings
  waitForPrevious  Boolean @default(true)
  continueOnError  Boolean @default(false)

  workflow Workflow @relation(fields: [workflowId], references: [id], onDelete: Cascade)

  @@unique([workflowId, order])
  @@index([workflowId])
  @@index([toolId])
}

model WorkflowRun {
  id          String    @id @default(uuid())
  workflowId  String
  userId      String
  status      String    @default("pending") // pending, running, completed, failed
  startedAt   DateTime  @default(now())
  completedAt DateTime?
  errorMsg    String?   @db.Text
  results     Json? // Outputs from all steps

  workflow Workflow @relation(fields: [workflowId], references: [id])

  @@index([workflowId])
  @@index([userId])
  @@index([status])
  @@index([startedAt])
}

// ============================================================================
// SCHEDULED RUNS
// ============================================================================

model ScheduledJob {
  id             String    @id @default(uuid())
  workspaceId    String?
  organizationId String?
  type           String // tool, workflow
  toolId         String?
  workflowId     String?
  name           String
  description    String?   @db.Text
  cronExpression String? // Cron format for scheduling
  frequency      String? // daily, weekly, monthly (alternative to cron)
  timezone       String    @default("UTC")
  config         Json // Tool/workflow input configuration
  enabled        Boolean   @default(true)
  nextRunAt      DateTime?
  lastRunAt      DateTime?
  lastStatus     String? // completed, failed
  emailResults   Boolean   @default(false)
  emailTo        Json? // Array of email addresses
  createdById    String
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  @@index([workspaceId])
  @@index([organizationId])
  @@index([type])
  @@index([enabled])
  @@index([nextRunAt])
}

// ============================================================================
// BULK PROCESSING
// ============================================================================

model BulkJob {
  id             String    @id @default(uuid())
  workspaceId    String?
  organizationId String?
  name           String
  toolId         String
  config         Json // Tool configuration
  status         String    @default("pending") // pending, processing, completed, failed, cancelled
  inputZipKey    String // Storage key for input ZIP
  outputZipKey   String? // Storage key for results ZIP
  totalFiles     Int
  processedFiles Int       @default(0)
  failedFiles    Int       @default(0)
  errorMsg       String?   @db.Text
  createdById    String
  createdAt      DateTime  @default(now())
  startedAt      DateTime?
  completedAt    DateTime?

  files BulkFile[]

  @@index([workspaceId])
  @@index([organizationId])
  @@index([toolId])
  @@index([status])
  @@index([createdById])
  @@index([createdAt])
}

model BulkFile {
  id         String    @id @default(uuid())
  bulkJobId  String
  fileName   String
  status     String    @default("pending") // pending, processing, completed, failed
  inputKey   String? // Storage key for input file
  outputKey  String? // Storage key for output file
  errorMsg   String?   @db.Text
  processedAt DateTime?

  bulkJob BulkJob @relation(fields: [bulkJobId], references: [id], onDelete: Cascade)

  @@index([bulkJobId])
  @@index([status])
}

// ============================================================================
// SYSTEM SETTINGS
// ============================================================================

model SystemSetting {
  key       String   @id
  value     String   @db.Text
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ============================================================================
// MARKETING & LAUNCH
// ============================================================================

model WaitlistEntry {
  id        String   @id @default(uuid())
  email     String   @unique
  name      String?
  source    String?  // where they signed up from (homepage, product_hunt, etc.)
  status    String   @default("pending") // pending, invited, converted
  invitedAt DateTime?
  createdAt DateTime @default(now())

  @@index([status])
  @@index([createdAt])
}

model BlogPost {
  id          String    @id @default(uuid())
  slug        String    @unique
  title       String
  excerpt     String?   @db.Text
  content     String    @db.Text
  coverImage  String?
  authorId    String?
  status      String    @default("draft") // draft, scheduled, published
  publishedAt DateTime?
  scheduledAt DateTime?
  tags        Json?     // Array of tags
  seoTitle    String?
  seoDescription String? @db.Text
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([status])
  @@index([publishedAt])
  @@index([slug])
}

model SocialPost {
  id          String    @id @default(uuid())
  platform    String    // twitter, linkedin, facebook
  content     String    @db.Text
  mediaUrl    String?
  status      String    @default("draft") // draft, scheduled, published, failed
  scheduledAt DateTime?
  publishedAt DateTime?
  externalId  String?   // ID from the social platform
  errorMsg    String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([platform])
  @@index([status])
  @@index([scheduledAt])
}

model LaunchMetric {
  id        String   @id @default(uuid())
  date      DateTime @db.Date
  signups   Int      @default(0)
  toolRuns  Int      @default(0)
  activeUsers Int    @default(0)
  conversions Int    @default(0)
  revenue   Float    @default(0)
  errorRate Float    @default(0)
  avgResponseTime Float @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([date])
  @@index([date])
}

// ============================================================================
// PHASE 11: ENTERPRISE SSO & IDENTITY
// ============================================================================

model SSOConfig {
  id               String   @id @default(uuid())
  organizationId   String   @unique
  provider         String   // saml, oauth, azure_ad, okta
  enabled          Boolean  @default(false)
  // SAML Configuration
  samlEntityId     String?
  samlSsoUrl       String?
  samlCertificate  String?  @db.Text
  samlSignRequest  Boolean  @default(false)
  // OAuth Configuration
  oauthClientId    String?
  oauthClientSecret String?
  oauthAuthUrl     String?
  oauthTokenUrl    String?
  oauthUserInfoUrl String?
  oauthScopes      String?
  // Azure AD / Okta specific
  tenantId         String?
  domain           String?
  // Settings
  autoProvision    Boolean  @default(true) // Auto-create users on first login
  defaultRole      String   @default("member")
  enforceSSO       Boolean  @default(false) // Require SSO for all users
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@index([organizationId])
  @@index([provider])
}

model SSOSession {
  id             String   @id @default(uuid())
  userId         String
  organizationId String
  ssoConfigId    String
  sessionToken   String   @unique
  idpSessionId   String?  // Session ID from identity provider
  expiresAt      DateTime
  createdAt      DateTime @default(now())

  @@index([userId])
  @@index([organizationId])
  @@index([sessionToken])
}

// ============================================================================
// PHASE 11: ADVANCED SECURITY
// ============================================================================

model IPWhitelist {
  id             String   @id @default(uuid())
  organizationId String
  ipAddress      String   // Can be CIDR notation (e.g., 192.168.1.0/24)
  description    String?
  enabled        Boolean  @default(true)
  createdById    String
  createdAt      DateTime @default(now())

  @@unique([organizationId, ipAddress])
  @@index([organizationId])
}

model DataRetentionPolicy {
  id             String   @id @default(uuid())
  organizationId String   @unique
  toolRunsRetention Int   @default(365) // Days to retain tool runs
  auditLogsRetention Int  @default(730) // Days to retain audit logs
  documentsRetention Int  @default(365) // Days to retain documents
  autoDelete     Boolean  @default(false)
  lastCleanupAt  DateTime?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([organizationId])
}

model EnhancedAuditLog {
  id             String   @id @default(uuid())
  organizationId String
  userId         String?
  eventType      String   // login, logout, tool_run, data_export, settings_change, etc.
  eventCategory  String   // security, data, admin, user
  resourceType   String?  // user, tool, document, organization
  resourceId     String?
  action         String   // create, read, update, delete, export
  details        Json?
  ipAddress      String?
  userAgent      String?
  geoLocation    String?
  riskLevel      String   @default("low") // low, medium, high, critical
  createdAt      DateTime @default(now())

  @@index([organizationId])
  @@index([userId])
  @@index([eventType])
  @@index([eventCategory])
  @@index([riskLevel])
  @@index([createdAt])
}

// ============================================================================
// PHASE 11: CUSTOM BRANDING / WHITE-LABEL
// ============================================================================

model OrganizationBranding {
  id               String   @id @default(uuid())
  organizationId   String   @unique
  // Domain
  customDomain     String?  @unique // e.g., ai.lawfirm.com
  domainVerified   Boolean  @default(false)
  domainVerifyToken String?
  // Logo & Colors
  logoUrl          String?
  logoLightUrl     String?  // For dark backgrounds
  faviconUrl       String?
  primaryColor     String   @default("#3B82F6")
  secondaryColor   String   @default("#6366F1")
  accentColor      String   @default("#10B981")
  // Text
  companyName      String?  // Override "Frith AI"
  tagline          String?
  supportEmail     String?
  // Features
  hideFooterBranding Boolean @default(false)
  customCss        String?  @db.Text
  customJs         String?  @db.Text
  // Email branding
  emailFromName    String?
  emailHeaderHtml  String?  @db.Text
  emailFooterHtml  String?  @db.Text
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@index([organizationId])
  @@index([customDomain])
}

// ============================================================================
// PHASE 11: ADVANCED ANALYTICS & REPORTING
// ============================================================================

model CustomReport {
  id             String   @id @default(uuid())
  organizationId String
  name           String
  description    String?
  reportType     String   // usage, billing, compliance, custom
  config         Json     // Report configuration (filters, columns, etc.)
  schedule       String?  // cron expression for scheduled reports
  lastRunAt      DateTime?
  recipients     Json?    // Array of email addresses
  format         String   @default("pdf") // pdf, csv, xlsx
  createdById    String
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([organizationId])
  @@index([reportType])
  @@index([createdById])
}

model ReportExport {
  id             String   @id @default(uuid())
  reportId       String?
  organizationId String
  exportType     String   // full_data, usage, billing, audit
  format         String   // csv, xlsx, json, pdf
  status         String   @default("pending") // pending, processing, completed, failed
  fileUrl        String?
  fileSize       Int?
  rowCount       Int?
  filters        Json?
  requestedById  String
  errorMsg       String?
  createdAt      DateTime @default(now())
  completedAt    DateTime?
  expiresAt      DateTime?

  @@index([organizationId])
  @@index([reportId])
  @@index([status])
  @@index([requestedById])
}

model UsageAnalytics {
  id             String   @id @default(uuid())
  organizationId String
  date           DateTime @db.Date
  // Tool usage
  toolRuns       Int      @default(0)
  uniqueUsers    Int      @default(0)
  tokensUsed     Int      @default(0)
  aiCost         Float    @default(0)
  // By category breakdown (JSON)
  byCategory     Json?
  byTool         Json?
  byUser         Json?
  // Performance
  avgRunTime     Float?
  errorRate      Float?
  createdAt      DateTime @default(now())

  @@unique([organizationId, date])
  @@index([organizationId])
  @@index([date])
}

// ============================================================================
// PHASE 11: INTEGRATIONS
// ============================================================================

model Integration {
  id             String   @id @default(uuid())
  organizationId String
  type           String   // google_docs, imanage, netdocuments, slack, teams, dropbox, onedrive
  name           String
  enabled        Boolean  @default(true)
  // OAuth tokens
  accessToken    String?  @db.Text
  refreshToken   String?  @db.Text
  tokenExpiresAt DateTime?
  // Configuration
  config         Json?    // Integration-specific settings
  webhookUrl     String?
  webhookSecret  String?
  // Status
  status         String   @default("connected") // connected, disconnected, error
  lastSyncAt     DateTime?
  errorMsg       String?
  createdById    String
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@unique([organizationId, type])
  @@index([organizationId])
  @@index([type])
  @@index([status])
}

model IntegrationSync {
  id            String   @id @default(uuid())
  integrationId String
  direction     String   // import, export, bidirectional
  resourceType  String   // document, folder, message
  resourceId    String?
  externalId    String?
  status        String   @default("pending") // pending, syncing, completed, failed
  errorMsg      String?
  createdAt     DateTime @default(now())
  completedAt   DateTime?

  @@index([integrationId])
  @@index([status])
}

// ============================================================================
// PHASE 11: API MARKETPLACE
// ============================================================================

model APIKey {
  id             String   @id @default(uuid())
  organizationId String
  name           String
  keyHash        String   @unique // Hashed API key
  keyPrefix      String   // First 8 chars for identification (e.g., "fri_live_")
  permissions    Json     // Array of allowed endpoints/scopes
  rateLimit      Int      @default(1000) // Requests per hour
  enabled        Boolean  @default(true)
  lastUsedAt     DateTime?
  usageCount     Int      @default(0)
  expiresAt      DateTime?
  createdById    String
  createdAt      DateTime @default(now())

  @@index([organizationId])
  @@index([keyHash])
  @@index([keyPrefix])
}

model APIUsage {
  id             String   @id @default(uuid())
  apiKeyId       String
  organizationId String
  endpoint       String
  method         String
  statusCode     Int
  responseTimeMs Int
  requestSize    Int?
  responseSize   Int?
  ipAddress      String?
  createdAt      DateTime @default(now())

  @@index([apiKeyId])
  @@index([organizationId])
  @@index([endpoint])
  @@index([createdAt])
}

model MarketplaceTool {
  id             String   @id @default(uuid())
  developerId    String   // Organization ID of the developer
  name           String
  slug           String   @unique
  description    String   @db.Text
  longDescription String? @db.Text
  category       String
  icon           String?
  screenshots    Json?    // Array of screenshot URLs
  pricing        String   // free, paid, freemium
  pricePerRun    Float?
  monthlyPrice   Float?
  // Technical
  apiEndpoint    String?
  webhookUrl     String?
  inputSchema    Json?    // JSON Schema for input
  outputSchema   Json?    // JSON Schema for output
  // Status
  status         String   @default("draft") // draft, pending_review, approved, rejected, published
  reviewNotes    String?  @db.Text
  publishedAt    DateTime?
  // Stats
  installCount   Int      @default(0)
  rating         Float?
  reviewCount    Int      @default(0)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  installations MarketplaceInstall[]

  @@index([developerId])
  @@index([slug])
  @@index([category])
  @@index([status])
}

model MarketplaceInstall {
  id             String   @id @default(uuid())
  toolId         String
  organizationId String
  installedById  String
  enabled        Boolean  @default(true)
  config         Json?    // Organization-specific configuration
  createdAt      DateTime @default(now())

  tool MarketplaceTool @relation(fields: [toolId], references: [id])

  @@unique([toolId, organizationId])
  @@index([toolId])
  @@index([organizationId])
}

// ============================================================================
// PHASE 11: COMMUNITY FEATURES
// ============================================================================

model ForumCategory {
  id          String   @id @default(uuid())
  name        String
  slug        String   @unique
  description String?
  icon        String?
  sortOrder   Int      @default(0)
  isPrivate   Boolean  @default(false)
  createdAt   DateTime @default(now())

  topics ForumTopic[]

  @@index([slug])
}

model ForumTopic {
  id          String   @id @default(uuid())
  categoryId  String
  authorId    String
  title       String
  content     String   @db.Text
  isPinned    Boolean  @default(false)
  isLocked    Boolean  @default(false)
  viewCount   Int      @default(0)
  replyCount  Int      @default(0)
  lastReplyAt DateTime?
  lastReplyById String?
  status      String   @default("open") // open, closed, resolved
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  category ForumCategory @relation(fields: [categoryId], references: [id])
  replies  ForumReply[]

  @@index([categoryId])
  @@index([authorId])
  @@index([isPinned])
  @@index([createdAt])
}

model ForumReply {
  id         String   @id @default(uuid())
  topicId    String
  authorId   String
  content    String   @db.Text
  isAccepted Boolean  @default(false) // Marked as answer
  upvotes    Int      @default(0)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  topic ForumTopic @relation(fields: [topicId], references: [id], onDelete: Cascade)

  @@index([topicId])
  @@index([authorId])
}

model LiveChatSession {
  id             String    @id @default(uuid())
  visitorId      String?   // For anonymous visitors
  userId         String?   // For logged-in users
  organizationId String?
  agentId        String?   // Assigned support agent
  status         String    @default("waiting") // waiting, active, closed
  channel        String    @default("web") // web, mobile, widget
  // Handoff from AI chatbot
  handoffFrom    String?   // chatbot conversation ID
  handoffReason  String?
  // Timing
  startedAt      DateTime  @default(now())
  firstResponseAt DateTime?
  closedAt       DateTime?
  // Rating
  rating         Int?
  feedback       String?
  createdAt      DateTime  @default(now())

  messages LiveChatMessage[]

  @@index([userId])
  @@index([agentId])
  @@index([status])
  @@index([createdAt])
}

model LiveChatMessage {
  id        String   @id @default(uuid())
  sessionId String
  senderId  String?  // User ID or agent ID
  senderType String  // visitor, user, agent, system
  content   String   @db.Text
  attachments Json?  // Array of attachment URLs
  readAt    DateTime?
  createdAt DateTime @default(now())

  session LiveChatSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@index([createdAt])
}

model SupportAgent {
  id             String   @id @default(uuid())
  userId         String   @unique
  displayName    String
  avatar         String?
  status         String   @default("offline") // online, away, busy, offline
  maxConcurrent  Int      @default(5) // Max concurrent chats
  currentChats   Int      @default(0)
  skills         Json?    // Array of skill tags
  languages      Json?    // Array of languages
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([status])
}

// ============================================================================
// PHASE 11: TOOL EXPANSION TRACKING
// ============================================================================

model ToolWave {
  id          String   @id @default(uuid())
  waveNumber  Int      @unique
  name        String
  description String?
  targetCount Int      // Target number of tools
  startDate   DateTime?
  endDate     DateTime?
  status      String   @default("planned") // planned, in_progress, completed
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  tools ToolExpansion[]

  @@index([status])
}

model ToolExpansion {
  id              String   @id @default(uuid())
  waveId          String
  toolId          String?  // Link to actual Tool once created
  name            String
  category        String
  priority        Int      @default(0)
  status          String   @default("planned") // planned, in_development, testing, deployed
  // From ai-agents.md spec
  specSource      String?  // Reference to spec document
  complexity      String   @default("medium") // low, medium, high
  estimatedHours  Int?
  // Development tracking
  assignedTo      String?
  startedAt       DateTime?
  completedAt     DateTime?
  // Evaluation
  evaluationScore Float?
  evaluationPassed Boolean @default(false)
  evaluationNotes String?  @db.Text
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  wave ToolWave @relation(fields: [waveId], references: [id])

  @@index([waveId])
  @@index([toolId])
  @@index([status])
  @@index([category])
}

// ============================================================================
// PHASE 11: MOBILE APP SUPPORT
// ============================================================================

model MobileDevice {
  id           String   @id @default(uuid())
  userId       String
  deviceId     String   @unique // Unique device identifier
  platform     String   // ios, android
  model        String?
  osVersion    String?
  appVersion   String?
  pushToken    String?  // FCM/APNs token
  pushEnabled  Boolean  @default(true)
  lastActiveAt DateTime?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([userId])
  @@index([deviceId])
  @@index([platform])
}

model PushNotification {
  id          String   @id @default(uuid())
  userId      String
  deviceId    String?
  title       String
  body        String
  data        Json?    // Custom payload
  status      String   @default("pending") // pending, sent, delivered, failed
  sentAt      DateTime?
  deliveredAt DateTime?
  errorMsg    String?
  createdAt   DateTime @default(now())

  @@index([userId])
  @@index([deviceId])
  @@index([status])
  @@index([createdAt])
}

// ============================================================================
// PHASE 12.5: LEGAL WEB SEARCH & EVIDENCE DISCOVERY (TOOL #241)
// ============================================================================

model WebSearchQuery {
  id              String   @id @default(uuid())
  userId          String
  projectId       String?  // Link to matter/project
  
  // Query
  queryText       String
  searchMode      String   @default("quick") // quick, deep, targeted, monitor
  searchType      String?  // person, company, property, case
  sources         String[] // web, news, courts, gov, social, corporate
  
  // Filters
  dateRangeStart  DateTime?
  dateRangeEnd    DateTime?
  jurisdiction    String?
  
  // AI Enhancement
  expandedQuery   String?  // AI-expanded query terms
  relatedTerms    String[]
  
  // Results
  resultCount     Int      @default(0)
  
  // Status
  status          String   @default("pending") // pending, processing, completed, failed
  errorMessage    String?
  
  // Timestamps
  createdAt       DateTime @default(now())
  completedAt     DateTime?
  
  // Relations
  results         WebSearchResult[]
  
  @@index([userId])
  @@index([projectId])
  @@index([status])
  @@index([createdAt])
}

model WebSearchResult {
  id              String   @id @default(uuid())
  queryId         String
  
  // Source
  sourceType      String   // web, news, court, gov, social, corporate
  sourceUrl       String
  sourceDomain    String
  
  // Content
  title           String
  snippet         String   @db.Text
  fullContent     String?  @db.Text
  publishedDate   DateTime?
  author          String?
  
  // AI Analysis
  relevanceScore  Int      @default(0) // 0-100
  evidenceValue   String   @default("none") // high, medium, low, none
  evidenceType    String?  // documentary, testimonial, demonstrative
  suggestedUse    String?  // impeachment, corroboration, direct
  keyFindings     String[]
  mentionedEntities Json?  // {people, companies, dates, amounts}
  suggestedActions String[]
  
  // Credibility
  credibilityScore Int?    // 0-100
  biasIndicators  String[]
  factCheckStatus String?  // verified, disputed, unverified
  
  // Admissibility
  admissibilityNotes Json? // {hearsay, authentication, bestEvidence, privilege}
  
  // Citation
  citationBluebook String?
  citationAlwd    String?
  archivedUrl     String?  // Wayback Machine or internal archive
  archivedAt      DateTime?
  
  // User Actions
  isSaved         Boolean  @default(false)
  savedToProjectId String?
  userNotes       String?
  userTags        String[]
  
  createdAt       DateTime @default(now())
  
  query           WebSearchQuery @relation(fields: [queryId], references: [id], onDelete: Cascade)
  
  @@index([queryId])
  @@index([relevanceScore])
  @@index([evidenceValue])
}

model WebSearchMonitor {
  id              String   @id @default(uuid())
  userId          String
  projectId       String?  // Link to matter/project
  
  // Monitor Config
  monitorName     String
  queryText       String
  sources         String[]
  
  // Schedule
  frequency       String   @default("daily") // daily, weekly, realtime
  
  // Notifications
  notifyEmail     Boolean  @default(true)
  notifyInApp     Boolean  @default(true)
  minRelevanceScore Int    @default(70)
  
  // Status
  isActive        Boolean  @default(true)
  lastRunAt       DateTime?
  nextRunAt       DateTime?
  
  // Results
  totalResults    Int      @default(0)
  newResults      Int      @default(0)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([userId])
  @@index([projectId])
  @@index([isActive])
  @@index([nextRunAt])
}

model WebSearchArchive {
  id              String   @id @default(uuid())
  userId          String
  resultId        String?
  
  originalUrl     String
  archivedContent String   @db.Text
  archivedHtml    String?  @db.Text
  screenshotUrl   String?
  
  // Metadata
  createdAt       DateTime @default(now())
  contentHash     String   // SHA-256 hash for integrity verification
  captureMethod   String   @default("local") // wayback, local
  captureHeaders  Json?    // HTTP headers at capture time
  
  // Legal
  certificationData Json?  // For authentication purposes
  
  @@index([userId])
  @@index([resultId])
  @@index([originalUrl])
}

// ============================================================================
// PHASE 12: LEGAL ERP - CONTACTS & MATTERS (Foundation)
// ============================================================================

model Contact {
  id              String   @id @default(uuid())
  organizationId  String
  contactType     String   // client, prospect, vendor, expert_witness, opposing_counsel
  
  // Basic Info
  firstName       String?
  lastName        String?
  companyName     String?
  displayName     String   // Computed: firstName lastName or companyName
  email           String?
  phone           String?
  mobile          String?
  
  // Address
  address1        String?
  address2        String?
  city            String?
  state           String?
  postalCode      String?
  country         String   @default("US")
  
  // Billing
  billingEmail    String?
  billingAddress1 String?
  billingAddress2 String?
  billingCity     String?
  billingState    String?
  billingPostalCode String?
  billingCountry  String?
  
  // Status
  status          String   @default("active") // active, inactive, archived
  isActive        Boolean  @default(true)
  
  // Metadata
  source          String?  // referral, website, marketing
  notes           String?  @db.Text
  tags            String[]
  customFields    Json?
  
  createdBy       String
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  organization    Organization @relation(fields: [organizationId], references: [id])
  matters         Matter[]
  invoices        Invoice[]
  payments        Payment[]
  trustLedgers    ClientTrustLedger[]
  expenses        Expense[]
  
  @@index([organizationId])
  @@index([contactType])
  @@index([email])
  @@index([status])
}

model Matter {
  id              String   @id @default(uuid())
  matterNumber    String   // Auto-generated: MAT-2025-0001
  organizationId  String
  clientId        String
  
  // Matter Info
  name            String
  description     String?  @db.Text
  matterType      String   // litigation, corporate, estate, family, criminal, etc.
  practiceArea    String?
  
  // Status
  status          String   @default("active") // active, pending, closed, archived
  openDate        DateTime @default(now())
  closeDate       DateTime?
  
  // Billing
  billingType     String   @default("hourly") // hourly, fixed_fee, contingency, hybrid
  billingRate     Decimal? @db.Decimal(15, 2)
  contingencyPercent Decimal? @db.Decimal(5, 2)
  estimatedFees   Decimal? @db.Decimal(15, 2)
  budgetAmount    Decimal? @db.Decimal(15, 2)
  
  // Responsible
  responsibleAttorneyId String?
  originatingAttorneyId String?
  
  // Court/Case Info
  courtName       String?
  caseNumber      String?
  jurisdiction    String?
  judge           String?
  
  // Conflict Check
  conflictCheckCompleted Boolean @default(false)
  conflictCheckDate DateTime?
  conflictCheckBy String?
  
  notes           String?  @db.Text
  customFields    Json?
  
  createdBy       String
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  organization    Organization @relation(fields: [organizationId], references: [id])
  client          Contact      @relation(fields: [clientId], references: [id])
  timeEntries     TimeEntry[]
  invoices        Invoice[]
  expenses        Expense[]
  trustLedgers    ClientTrustLedger[]
  vendorBills     VendorBill[]
  
  @@unique([organizationId, matterNumber])
  @@index([organizationId])
  @@index([clientId])
  @@index([status])
  @@index([matterType])
}

model TimeEntry {
  id              String   @id @default(uuid())
  organizationId  String
  userId          String   // Attorney/timekeeper
  matterId        String
  
  // Time
  date            DateTime
  hours           Decimal  @db.Decimal(5, 2)
  
  // Billing
  rate            Decimal  @db.Decimal(15, 2)
  amount          Decimal  @db.Decimal(15, 2)
  isBillable      Boolean  @default(true)
  isBilled        Boolean  @default(false)
  
  // Description
  description     String   @db.Text
  
  // UTBMS Codes
  utbmsTaskCode   String?
  utbmsActivityCode String?
  
  // Status
  status          String   @default("draft") // draft, submitted, approved, billed
  approvedBy      String?
  approvedAt      DateTime?
  
  // Invoice Link
  invoiceLineItemId String?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  organization    Organization @relation(fields: [organizationId], references: [id])
  matter          Matter       @relation(fields: [matterId], references: [id])
  invoiceLineItem InvoiceLineItem?
  
  @@index([organizationId])
  @@index([userId])
  @@index([matterId])
  @@index([date])
  @@index([status])
}

// ============================================================================
// PHASE 12.1.1: CHART OF ACCOUNTS & GENERAL LEDGER
// ============================================================================

model ChartOfAccount {
  id              String   @id @default(uuid())
  organizationId  String
  accountNumber   String   // e.g., "1000-Assets-Cash"
  accountName     String
  accountType     String   // asset, liability, equity, revenue, expense
  parentId        String?  // For hierarchical structure
  currency        String   @default("USD")
  isActive        Boolean  @default(true)
  description     String?
  normalBalance   String   // debit, credit
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  organization    Organization @relation(fields: [organizationId], references: [id])
  parent          ChartOfAccount? @relation("AccountHierarchy", fields: [parentId], references: [id])
  children        ChartOfAccount[] @relation("AccountHierarchy")
  transactions    GeneralLedgerEntry[]
  
  @@unique([organizationId, accountNumber])
  @@index([organizationId])
  @@index([accountType])
  @@index([parentId])
}

model JournalEntry {
  id              String   @id @default(uuid())
  organizationId  String
  journalNumber   String   // Auto-generated: JE-2025-0001
  journalType     String   // standard, adjusting, closing, reversing
  description     String
  postedDate      DateTime
  status          String   @default("draft") // draft, posted, reversed
  totalDebit      Decimal  @db.Decimal(15, 2)
  totalCredit     Decimal  @db.Decimal(15, 2)
  createdBy       String
  approvedBy      String?
  approvedAt      DateTime?
  createdAt       DateTime @default(now())
  
  organization    Organization @relation(fields: [organizationId], references: [id])
  entries         GeneralLedgerEntry[]
  
  @@unique([organizationId, journalNumber])
  @@index([organizationId])
  @@index([status])
  @@index([postedDate])
}

model GeneralLedgerEntry {
  id              String   @id @default(uuid())
  organizationId  String
  accountId       String
  journalId       String   // Groups related entries
  debit           Decimal  @db.Decimal(15, 2)
  credit          Decimal  @db.Decimal(15, 2)
  description     String
  referenceId     String?  // Links to invoice, expense, trust transfer
  referenceType   String?  // invoice, expense, trust_transfer, manual
  currency        String   @default("USD")
  exchangeRate    Decimal? @db.Decimal(10, 6)
  baseCurrencyAmount Decimal? @db.Decimal(15, 2)
  postedDate      DateTime
  fiscalYear      Int
  fiscalPeriod    Int      // 1-12 for months
  isReconciled    Boolean  @default(false)
  reconciledAt    DateTime?
  reconciledBy    String?
  createdBy       String
  createdAt       DateTime @default(now())
  
  organization    Organization @relation(fields: [organizationId], references: [id])
  account         ChartOfAccount @relation(fields: [accountId], references: [id])
  journal         JournalEntry @relation(fields: [journalId], references: [id])
  
  @@index([organizationId])
  @@index([accountId])
  @@index([journalId])
  @@index([postedDate])
  @@index([fiscalYear, fiscalPeriod])
}

// ============================================================================
// PHASE 12.1.2: TRUST ACCOUNTING & IOLTA COMPLIANCE
// ============================================================================

model TrustAccount {
  id              String   @id @default(uuid())
  organizationId  String
  accountName     String   // e.g., "IOLTA Account - Bank of America"
  bankName        String
  accountNumber   String   // Encrypted
  routingNumber   String?  // Encrypted
  accountType     String   @default("IOLTA") // IOLTA, client_trust, escrow
  currency        String   @default("USD")
  currentBalance  Decimal  @db.Decimal(15, 2) @default(0)
  lastReconciledBalance Decimal? @db.Decimal(15, 2)
  lastReconciledDate DateTime?
  isActive        Boolean  @default(true)
  jurisdiction    String   // e.g., "California", "New York"
  stateBarId      String?  // State bar identifier
  interestRate    Decimal? @db.Decimal(5, 4) // For interest-bearing accounts
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  organization    Organization @relation(fields: [organizationId], references: [id])
  transactions    TrustTransaction[]
  clientLedgers   ClientTrustLedger[]
  reconciliations TrustReconciliation[]
  bankStatements  BankStatement[]
  
  @@index([organizationId])
  @@index([jurisdiction])
  @@index([isActive])
}

model ClientTrustLedger {
  id              String   @id @default(uuid())
  trustAccountId  String
  clientId        String
  matterId        String?
  ledgerName      String   // Display name for this ledger
  balance         Decimal  @db.Decimal(15, 2) @default(0)
  currency        String   @default("USD")
  status          String   @default("active") // active, dormant, closed
  lastActivityAt  DateTime?
  dormantSince    DateTime?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  trustAccount    TrustAccount @relation(fields: [trustAccountId], references: [id])
  client          Contact      @relation(fields: [clientId], references: [id])
  matter          Matter?      @relation(fields: [matterId], references: [id])
  transactions    TrustTransaction[]
  
  @@unique([trustAccountId, clientId, matterId])
  @@index([trustAccountId])
  @@index([clientId])
  @@index([status])
}

model TrustTransaction {
  id              String   @id @default(uuid())
  trustAccountId  String
  clientLedgerId  String
  transactionType String   // deposit, transfer_to_operating, disbursement, refund, interest
  amount          Decimal  @db.Decimal(15, 2)
  runningBalance  Decimal  @db.Decimal(15, 2) // Balance after this transaction
  currency        String   @default("USD")
  description     String
  paymentMethod   String?  // check, wire, credit_card, ach, cash
  checkNumber     String?
  referenceNumber String?  // Invoice ID if transferring earned fees
  payee           String?  // For disbursements
  fromAccount     String?  // For transfers
  toAccount       String?
  transactionDate DateTime
  postedDate      DateTime?
  clearedDate     DateTime?
  isCleared       Boolean  @default(false)
  isReconciled    Boolean  @default(false)
  reconciledDate  DateTime?
  reconciledBy    String?
  voidedAt        DateTime?
  voidedBy        String?
  voidReason      String?
  createdBy       String
  approvedBy      String?
  approvedAt      DateTime?
  createdAt       DateTime @default(now())
  
  trustAccount    TrustAccount       @relation(fields: [trustAccountId], references: [id])
  clientLedger    ClientTrustLedger  @relation(fields: [clientLedgerId], references: [id])
  auditLogs       TrustAuditLog[]
  
  @@index([trustAccountId])
  @@index([clientLedgerId])
  @@index([transactionDate])
  @@index([isReconciled])
}

model TrustReconciliation {
  id                  String   @id @default(uuid())
  trustAccountId      String
  reconciliationDate  DateTime
  periodStart         DateTime
  periodEnd           DateTime
  bankStatementId     String?
  bankBalance         Decimal  @db.Decimal(15, 2)
  trustLedgerBalance  Decimal  @db.Decimal(15, 2)
  clientLedgersTotal  Decimal  @db.Decimal(15, 2)
  outstandingDeposits Decimal  @db.Decimal(15, 2) @default(0)
  outstandingChecks   Decimal  @db.Decimal(15, 2) @default(0)
  adjustedBankBalance Decimal  @db.Decimal(15, 2)
  isBalanced          Boolean  @default(false)
  discrepancy         Decimal? @db.Decimal(15, 2)
  discrepancyNotes    String?
  status              String   @default("draft") // draft, completed, approved
  notes               String?
  reconciledBy        String
  approvedBy          String?
  approvedAt          DateTime?
  createdAt           DateTime @default(now())
  
  trustAccount        TrustAccount @relation(fields: [trustAccountId], references: [id])
  bankStatement       BankStatement? @relation(fields: [bankStatementId], references: [id])
  
  @@index([trustAccountId])
  @@index([reconciliationDate])
  @@index([status])
}

model BankStatement {
  id              String   @id @default(uuid())
  trustAccountId  String
  statementDate   DateTime
  periodStart     DateTime
  periodEnd       DateTime
  openingBalance  Decimal  @db.Decimal(15, 2)
  closingBalance  Decimal  @db.Decimal(15, 2)
  totalDeposits   Decimal  @db.Decimal(15, 2)
  totalWithdrawals Decimal @db.Decimal(15, 2)
  fileUrl         String?  // Uploaded statement file
  importedAt      DateTime @default(now())
  importedBy      String
  
  trustAccount    TrustAccount @relation(fields: [trustAccountId], references: [id])
  reconciliations TrustReconciliation[]
  transactions    BankStatementTransaction[]
  
  @@index([trustAccountId])
  @@index([statementDate])
}

model BankStatementTransaction {
  id              String   @id @default(uuid())
  bankStatementId String
  transactionDate DateTime
  description     String
  amount          Decimal  @db.Decimal(15, 2)
  transactionType String   // debit, credit
  checkNumber     String?
  referenceNumber String?
  isMatched       Boolean  @default(false)
  matchedTransactionId String?
  
  bankStatement   BankStatement @relation(fields: [bankStatementId], references: [id])
  
  @@index([bankStatementId])
  @@index([isMatched])
}

model TrustAuditLog {
  id                 String   @id @default(uuid())
  trustTransactionId String?
  eventType          String   // created, modified, voided, reconciled, approved
  eventData          Json
  userId             String
  ipAddress          String?
  userAgent          String?
  createdAt          DateTime @default(now())
  
  transaction        TrustTransaction? @relation(fields: [trustTransactionId], references: [id])
  
  @@index([trustTransactionId])
  @@index([eventType])
  @@index([createdAt])
}

model JurisdictionRule {
  id              String   @id @default(uuid())
  jurisdiction    String   // "California", "New York", "England & Wales"
  country         String
  ruleType        String   // trust_accounting, interest_distribution, reporting
  ruleName        String
  ruleDescription String
  ruleData        Json     // Specific rule parameters
  effectiveDate   DateTime
  expirationDate  DateTime?
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  
  @@unique([jurisdiction, ruleType, ruleName])
  @@index([jurisdiction])
  @@index([ruleType])
  @@index([isActive])
}

// ============================================================================
// PHASE 12.1.3: BILLING & INVOICING
// ============================================================================

model Invoice {
  id              String   @id @default(uuid())
  invoiceNumber   String   // Auto-generated: INV-2025-0001
  organizationId  String
  clientId        String
  matterId        String?
  billingType     String   // hourly, fixed_fee, contingency, hybrid
  status          String   @default("draft") // draft, pending_approval, approved, sent, viewed, paid, overdue, cancelled, written_off
  issueDate       DateTime
  dueDate         DateTime
  paymentTerms    String?  // "Net 30", "Upon Receipt", "Net 15"
  
  // Amounts
  subtotal        Decimal  @db.Decimal(15, 2)
  discountType    String?  // percentage, fixed
  discountValue   Decimal? @db.Decimal(15, 2)
  discountAmount  Decimal  @db.Decimal(15, 2) @default(0)
  taxRate         Decimal? @db.Decimal(5, 4)
  taxAmount       Decimal  @db.Decimal(15, 2) @default(0)
  totalAmount     Decimal  @db.Decimal(15, 2)
  paidAmount      Decimal  @db.Decimal(15, 2) @default(0)
  balanceDue      Decimal  @db.Decimal(15, 2)
  writeOffAmount  Decimal  @db.Decimal(15, 2) @default(0)
  
  // Currency
  currency        String   @default("USD")
  exchangeRate    Decimal? @db.Decimal(10, 6)
  baseCurrencyTotal Decimal? @db.Decimal(15, 2)
  
  // LEDES/UTBMS
  ledesFormat     Boolean  @default(false)
  ledesVersion    String?  // "LEDES98B", "LEDES2000"
  
  // Metadata
  notes           String?
  internalNotes   String?
  termsAndConditions String?
  
  // AI Predictions
  aiPaymentProbability Int?    // 1-100
  aiSuggestedWriteOff Decimal? @db.Decimal(15, 2)
  
  // Timestamps
  sentAt          DateTime?
  viewedAt        DateTime?
  paidAt          DateTime?
  lastReminderAt  DateTime?
  reminderCount   Int      @default(0)
  
  createdBy       String
  approvedBy      String?
  approvedAt      DateTime?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  organization    Organization    @relation(fields: [organizationId], references: [id])
  client          Contact         @relation(fields: [clientId], references: [id])
  matter          Matter?         @relation(fields: [matterId], references: [id])
  lineItems       InvoiceLineItem[]
  payments        Payment[]
  reminders       PaymentReminder[]
  
  @@unique([organizationId, invoiceNumber])
  @@index([organizationId])
  @@index([clientId])
  @@index([matterId])
  @@index([status])
  @@index([dueDate])
}

model InvoiceLineItem {
  id              String   @id @default(uuid())
  invoiceId       String
  lineNumber      Int
  itemType        String   // time_entry, expense, fixed_fee, adjustment, credit
  description     String
  quantity        Decimal  @db.Decimal(10, 2) // Hours or units
  rate            Decimal  @db.Decimal(15, 2)
  amount          Decimal  @db.Decimal(15, 2)
  
  // LEDES/UTBMS
  utbmsTaskCode   String?  // e.g., "L110" for Fact Investigation
  utbmsActivityCode String? // e.g., "A101" for Plan and Prepare
  utbmsExpenseCode String?  // e.g., "E101" for Copying
  
  // References
  timeEntryId     String?  @unique // Link to time entry
  expenseId       String?  @unique // Link to expense
  
  // Tax
  taxable         Boolean  @default(false)
  taxRate         Decimal? @db.Decimal(5, 4)
  taxAmount       Decimal  @db.Decimal(15, 2) @default(0)
  
  // Dates
  serviceDate     DateTime?
  serviceDateEnd  DateTime? // For date ranges
  
  createdAt       DateTime @default(now())
  
  invoice         Invoice    @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  timeEntry       TimeEntry? @relation(fields: [timeEntryId], references: [id])
  expense         Expense?   @relation(fields: [expenseId], references: [id])
  
  @@index([invoiceId])
  @@index([itemType])
}

model Payment {
  id              String   @id @default(uuid())
  organizationId  String
  invoiceId       String?
  clientId        String
  amount          Decimal  @db.Decimal(15, 2)
  currency        String   @default("USD")
  paymentMethod   String   // credit_card, ach, check, wire, cash, trust_transfer
  paymentDate     DateTime
  
  // Payment processor
  processorId     String?  // Stripe/LawPay payment ID
  processorFee    Decimal? @db.Decimal(15, 2)
  netAmount       Decimal? @db.Decimal(15, 2)
  
  // Check details
  checkNumber     String?
  bankName        String?
  
  // Trust transfer
  trustTransactionId String?
  
  // Status
  status          String   @default("completed") // pending, completed, failed, refunded
  failureReason   String?
  
  referenceNumber String?
  notes           String?
  processedBy     String
  createdAt       DateTime @default(now())
  
  organization    Organization @relation(fields: [organizationId], references: [id])
  invoice         Invoice?     @relation(fields: [invoiceId], references: [id])
  client          Contact      @relation(fields: [clientId], references: [id])
  allocations     PaymentAllocation[]
  
  @@index([organizationId])
  @@index([invoiceId])
  @@index([clientId])
  @@index([paymentDate])
  @@index([status])
}

model PaymentAllocation {
  id          String   @id @default(uuid())
  paymentId   String
  invoiceId   String
  amount      Decimal  @db.Decimal(15, 2)
  createdAt   DateTime @default(now())
  
  payment     Payment @relation(fields: [paymentId], references: [id])
  
  @@index([paymentId])
  @@index([invoiceId])
}

model PaymentReminder {
  id          String   @id @default(uuid())
  invoiceId   String
  reminderType String  // first, second, final, custom
  scheduledFor DateTime
  sentAt      DateTime?
  emailTo     String
  emailSubject String
  emailBody   String   @db.Text
  status      String   @default("scheduled") // scheduled, sent, cancelled
  createdAt   DateTime @default(now())
  
  invoice     Invoice @relation(fields: [invoiceId], references: [id])
  
  @@index([invoiceId])
  @@index([scheduledFor])
  @@index([status])
}

model BillingRate {
  id              String   @id @default(uuid())
  organizationId  String
  userId          String?  // Attorney
  clientId        String?  // Client-specific rate
  matterId        String?  // Matter-specific rate
  matterType      String?  // Rate by matter type
  rateType        String   // hourly, fixed, contingency
  rate            Decimal  @db.Decimal(15, 2)
  currency        String   @default("USD")
  effectiveDate   DateTime
  expirationDate  DateTime?
  isDefault       Boolean  @default(false)
  createdAt       DateTime @default(now())
  
  organization    Organization @relation(fields: [organizationId], references: [id])
  
  @@index([organizationId])
  @@index([userId])
  @@index([clientId])
  @@index([effectiveDate])
}

// ============================================================================
// PHASE 12.1.4: EXPENSE MANAGEMENT & ACCOUNTS PAYABLE
// ============================================================================

model Expense {
  id              String   @id @default(uuid())
  expenseNumber   String   // Auto-generated: EXP-2025-0001
  organizationId  String
  matterId        String?
  clientId        String?
  userId          String   // Who incurred the expense
  vendorId        String?
  
  // Expense Details
  category        String   // court_fees, expert_witness, travel, meals, etc.
  subcategory     String?
  description     String
  amount          Decimal  @db.Decimal(15, 2)
  currency        String   @default("USD")
  exchangeRate    Decimal? @db.Decimal(10, 6)
  baseCurrencyAmount Decimal? @db.Decimal(15, 2)
  taxAmount       Decimal  @db.Decimal(15, 2) @default(0)
  
  // Dates
  expenseDate     DateTime
  submittedAt     DateTime?
  
  // Billability
  isBillable      Boolean  @default(true)
  isBilled        Boolean  @default(false)
  invoiceLineItemId String? @unique
  markupPercent   Decimal? @db.Decimal(5, 2) // Markup for billing
  billedAmount    Decimal? @db.Decimal(15, 2)
  
  // Receipt
  receiptUrl      String?
  receiptOcrData  Json?    // AI-extracted data
  
  // Mileage
  isMileage       Boolean  @default(false)
  mileageDistance Decimal? @db.Decimal(10, 2)
  mileageRate     Decimal? @db.Decimal(5, 4)
  mileageStart    String?
  mileageEnd      String?
  
  // Payment
  paymentMethod   String?  // firm_card, personal, cash, vendor_invoice
  reimbursed      Boolean  @default(false)
  reimbursedAt    DateTime?
  reimbursementPaymentId String?
  
  // Approval
  status          String   @default("draft") // draft, submitted, pending_approval, approved, rejected, paid
  approvalStatus  String   @default("pending") // pending, approved, rejected
  approvedBy      String?
  approvedAt      DateTime?
  rejectionReason String?
  
  // Policy
  policyViolation Boolean  @default(false)
  policyViolationReason String?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  organization    Organization @relation(fields: [organizationId], references: [id])
  matter          Matter?      @relation(fields: [matterId], references: [id])
  client          Contact?     @relation(fields: [clientId], references: [id])
  vendor          Vendor?      @relation(fields: [vendorId], references: [id])
  invoiceLineItem InvoiceLineItem?
  
  @@unique([organizationId, expenseNumber])
  @@index([organizationId])
  @@index([matterId])
  @@index([userId])
  @@index([status])
  @@index([expenseDate])
}

model Vendor {
  id              String   @id @default(uuid())
  organizationId  String
  vendorNumber    String   // Auto-generated: VEN-0001
  name            String
  vendorType      String   // expert_witness, court_reporter, process_server, etc.
  
  // Contact
  email           String?
  phone           String?
  website         String?
  
  // Address
  address1        String?
  address2        String?
  city            String?
  state           String?
  postalCode      String?
  country         String   @default("US")
  
  // Tax
  taxId           String?  // Encrypted - For 1099 reporting
  taxIdType       String?  // EIN, SSN
  is1099Eligible  Boolean  @default(false)
  
  // Payment
  paymentTerms    String?  // Net 30, Net 15, Upon Receipt
  preferredPaymentMethod String? // check, ach, wire
  bankAccountNumber String? // Encrypted
  bankRoutingNumber String? // Encrypted
  
  // Performance
  rating          Decimal? @db.Decimal(3, 2) // 0-5.0 stars
  totalPaid       Decimal  @db.Decimal(15, 2) @default(0)
  totalInvoices   Int      @default(0)
  avgPaymentDays  Int?
  
  // Status
  isPreferred     Boolean  @default(false)
  isActive        Boolean  @default(true)
  notes           String?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  organization    Organization @relation(fields: [organizationId], references: [id])
  expenses        Expense[]
  bills           VendorBill[]
  payments        VendorPayment[]
  
  @@unique([organizationId, vendorNumber])
  @@index([organizationId])
  @@index([vendorType])
  @@index([isActive])
}

model VendorBill {
  id              String   @id @default(uuid())
  billNumber      String
  organizationId  String
  vendorId        String
  matterId        String?
  
  // Amounts
  subtotal        Decimal  @db.Decimal(15, 2)
  taxAmount       Decimal  @db.Decimal(15, 2) @default(0)
  totalAmount     Decimal  @db.Decimal(15, 2)
  paidAmount      Decimal  @db.Decimal(15, 2) @default(0)
  balanceDue      Decimal  @db.Decimal(15, 2)
  currency        String   @default("USD")
  
  // Dates
  billDate        DateTime
  dueDate         DateTime
  receivedDate    DateTime @default(now())
  
  // Status
  status          String   @default("pending") // pending, approved, scheduled, paid, cancelled
  approvalStatus  String   @default("pending")
  approvedBy      String?
  approvedAt      DateTime?
  
  // Payment
  scheduledPaymentDate DateTime?
  paidAt          DateTime?
  paymentMethod   String?
  paymentReference String?
  
  // Documents
  documentUrl     String?
  
  notes           String?
  createdBy       String
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  organization    Organization @relation(fields: [organizationId], references: [id])
  vendor          Vendor       @relation(fields: [vendorId], references: [id])
  matter          Matter?      @relation(fields: [matterId], references: [id])
  lineItems       VendorBillLineItem[]
  payments        VendorPayment[]
  
  @@index([organizationId])
  @@index([vendorId])
  @@index([status])
  @@index([dueDate])
}

model VendorBillLineItem {
  id          String   @id @default(uuid())
  billId      String
  description String
  quantity    Decimal  @db.Decimal(10, 2) @default(1)
  unitPrice   Decimal  @db.Decimal(15, 2)
  amount      Decimal  @db.Decimal(15, 2)
  accountId   String?  // Chart of accounts
  matterId    String?
  isBillable  Boolean  @default(false)
  createdAt   DateTime @default(now())
  
  bill        VendorBill @relation(fields: [billId], references: [id], onDelete: Cascade)
  
  @@index([billId])
}

model VendorPayment {
  id              String   @id @default(uuid())
  organizationId  String
  vendorId        String
  billId          String?
  amount          Decimal  @db.Decimal(15, 2)
  currency        String   @default("USD")
  paymentMethod   String   // check, ach, wire
  paymentDate     DateTime
  checkNumber     String?
  referenceNumber String?
  status          String   @default("completed")
  notes           String?
  processedBy     String
  createdAt       DateTime @default(now())
  
  organization    Organization @relation(fields: [organizationId], references: [id])
  vendor          Vendor       @relation(fields: [vendorId], references: [id])
  bill            VendorBill?  @relation(fields: [billId], references: [id])
  
  @@index([organizationId])
  @@index([vendorId])
  @@index([billId])
  @@index([paymentDate])
}

model ExpensePolicy {
  id              String   @id @default(uuid())
  organizationId  String
  policyName      String
  category        String?  // Apply to specific category or all
  maxAmount       Decimal? @db.Decimal(15, 2)
  requiresApproval Boolean @default(false)
  approvalThreshold Decimal? @db.Decimal(15, 2)
  requiresReceipt Boolean  @default(true)
  receiptThreshold Decimal? @db.Decimal(15, 2)
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  
  organization    Organization @relation(fields: [organizationId], references: [id])
  
  @@index([organizationId])
  @@index([category])
  @@index([isActive])
}

// ============================================================================
// PHASE 12.1.1: AI FINANCIAL ANOMALY DETECTION
// ============================================================================

model FinancialAnomaly {
  id                String   @id @default(uuid())
  organizationId    String
  
  // Transaction reference
  transactionType   String   // expense, journal_entry, payment, trust_transaction, invoice
  transactionId     String
  
  // Anomaly details
  anomalyType       String   // unusual_amount, unusual_pattern, duplicate, timing, potential_fraud, policy_violation
  severity          String   // low, medium, high, critical
  confidence        Decimal  @db.Decimal(5, 2) // 0-100
  description       String
  amount            Decimal? @db.Decimal(15, 2)
  
  // Detection metadata
  detectedAt        DateTime @default(now())
  detectionMethod   String?  // rule_based, ml_model, pattern_analysis
  metadata          Json?    // Additional context data
  
  // Review workflow
  status            String   @default("pending") // pending, reviewed, resolved, dismissed, escalated
  reviewedBy        String?
  reviewedAt        DateTime?
  resolution        String?  // approved, rejected, corrected, flagged_fraud
  resolutionNotes   String?
  
  // Timestamps
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  organization      Organization @relation(fields: [organizationId], references: [id])
  
  @@unique([organizationId, transactionType, transactionId, anomalyType])
  @@index([organizationId])
  @@index([transactionType])
  @@index([severity])
  @@index([status])
  @@index([detectedAt])
}
